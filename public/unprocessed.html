<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Blue House</title>

    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css"
    />
    <link rel="stylesheet" type="text/css" href="./static/style.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div id="categorize_card" class="card card-default">
      <div class="card-heading">
        <a data-toggle="collapse" href="#categorize_collapse"
          ><h3>Categorize</h3></a
        >
      </div>
      <div id="categorize_collapse" class="card-collapse collapse">
        <div class="card-body">
          <form id="categorize_form">
            <input type="text" /><br />
            <select size="1" id="cat_slug"></select
            ><br />
            <input type="submit" />
          </form>
        </div>
      </div>
    </div>

    <table id="transaction_table" class="display" style="width: 100%">
      <thead>
        <tr>
          <th></th>
          <th>Date</th>
          <th>Merchant</th>
          <th>Amount</th>
          <th>Notes</th>
          <th></th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th></th>
          <th>Date</th>
          <th>Merchant</th>
          <th>Amount</th>
          <th>Notes</th>
          <th></th>
        </tr>
      </tfoot>
    </table>

    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <script type="text/javascript">
      $(function () {
        var table = $('#transaction_table').DataTable({
          ajax: '/api/transactions/unprocessed',
          select: 'multiple',
          order: [[1, 'desc']],
          columns: [
            { data: 'shortId' },
            { data: 'transactionDate' },
            { data: 'merchant' },
            {
              data: 'amount',
              render: $.fn.dataTable.render.number(',', '.', 2, '$'),
            },
            { data: 'notes' },
            {
              render: function (data, type, row) {
                return (
                  '<button class="transfer-button" data-transaction-id="' +
                  row.id +
                  '">Transfer</button>'
                );
              },
            },
          ],
        });

        var slugSelect = $('#cat_slug');
        var form = $('#categorize_form');

        $('#transaction_table tbody').on('click', 'tr', function () {
          $(this).toggleClass('selected');
        });

        form.submit(function (e) {
          e.preventDefault();
          var selected = table.rows('.selected').data();
          var slug = slugSelect.val();

          // TODO disable button
          for (var i = selected.length - 1; i >= 0; i--) {
            // TODO perform in serial, then re-enable the button
            var row = selected[i];
            $.ajax({
              type: 'POST',
              url: '/api/transactions/categorize',
              data: JSON.stringify({
                trShortId: selected[i].shortId,
                catSlug: slug,
              }),
              contentType: 'application/json; charset=utf-8',
              dataType: 'json',
              success: function () {
                table.ajax.reload(null, false);
              },
              error: function () {
                alert('Failed categorizing transaction');
              },
            });
          }

          return false;
        });

        $('#transaction_table').on(
          'click',
          'button.transfer-button',
          function (e) {
            const trid = $(this).data().transactionId;
            e.stopPropagation();
            e.preventDefault();

            $.ajax({
              type: 'POST',
              url: '/api/transactions/categorize',
              data: JSON.stringify({
                trShortId: trid,
                isTransfer: true,
              }),
              contentType: 'application/json; charset=utf-8',
              dataType: 'json',
              success: function () {
                table.ajax.reload(null, false);
              },
              error: function () {
                alert('Failed marking transaction as transfer');
              },
            });
          },
        );
      });

      $.get('/api/transactions/categories')
        .done(function (resp) {
          $(function () {
            var select = document.getElementById('cat_slug');
            for (var i = resp.data.length - 1; i >= 0; i--) {
              var opt = document.createElement('option');
              opt.value = resp.data[i].slug;
              opt.textContent = resp.data[i].name;
              select.appendChild(opt);
            }
          });
        })
        .fail(function (err) {
          alert('Failed fetching categories');
        });
    </script>
  </body>
</html>
